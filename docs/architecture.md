# Архитектура системы: MCP-сервер для PydanticAI

## Обзор

Система состоит из двух основных компонентов: легковесного MCP-сервера, написанного на Go, и агентов PydanticAI, написанных на Python. MCP-сервер выступает в качестве центрального узла управления, позволяя удаленно запускать, останавливать и конфигурировать агентов PydanticAI. Конфигурация агентов хранится в текстовых файлах (JSON), которые обновляются MCP-сервером.

## Диаграмма архитектуры

```mermaid
graph TD
    subgraph Клиентская сторона
        A[Пользователь/MCP Клиент]
    end

    subgraph Серверная сторона (Go)
        B(MCP Go Сервер)
        B1[Модуль Обработки Команд MCP]
        B2[Модуль Управления Агентами]
        B3[Модуль Управления Конфигурацией]
        B4[Модуль Мониторинга (опционально)]

        B --> B1
        B --> B2
        B --> B3
        B --> B4
    end

    subgraph Агенты PydanticAI (Python)
        C[Агент PydanticAI 1]
        C2[Агент PydanticAI N]
    end

    subgraph Хранилище
        D[Файлы Конфигурации Агентов (JSON)]
    end

    A -->|Команды MCP (JSON/gRPC)| B
    B1 -->|Вызов функций| B2
    B1 -->|Вызов функций| B3
    B2 -->|Запуск/Остановка процессов| C
    B3 -->|Чтение/Запись| D
    C -->|Чтение конфигурации| D
    C -->|Логи/Статус| B4
```

## Детали компонентов

### 1. MCP Go Сервер

Ядро системы, написанное на Go для обеспечения высокой производительности и низкого потребления ресурсов.

*   **Модуль Обработки Команд MCP:**
    *   Отвечает за прием и парсинг входящих команд MCP от клиента.
    *   Маршрутизирует команды соответствующим внутренним модулям (управления агентами, управления конфигурацией).
    *   Предоставляет инструменты и ресурсы MCP.
*   **Модуль Управления Агентами:**
    *   Отвечает за запуск и остановку процессов агентов PydanticAI.
    *   Использует `os/exec` для взаимодействия с системными процессами.
    *   Может отслеживать состояние запущенных агентов (PID, статус).
    *   Передает агентам пути к их конфигурационным файлам при запуске.
*   **Модуль Управления Конфигурацией:**
    *   Отвечает за чтение, изменение и запись конфигурационных файлов агентов.
    *   Конфигурация хранится в формате JSON.
    *   Обеспечивает атомарность операций записи для предотвращения повреждения файлов.
    *   Может предоставлять API для получения текущей конфигурации агента.
*   **Модуль Мониторинга (опционально):**
    *   Собирает информацию о состоянии запущенных агентов (например, логи, использование ресурсов).
    *   Может предоставлять эту информацию через ресурсы MCP.

### 2. Агенты PydanticAI

Python-приложения, которые выполняют основную логику.

*   **Запуск:** Агенты запускаются MCP Go Сервером.
*   **Конфигурация:** При запуске агент читает свою конфигурацию из указанного JSON-файла. Использует Pydantic для валидации и загрузки конфигурации.
*   **Функциональность:** Выполняет задачи, определенные в его конфигурации.

### 3. Файлы Конфигурации Агентов

Текстовые файлы в формате JSON, содержащие параметры для каждого агента PydanticAI.

*   **Расположение:** Хранятся в предопределенной директории внутри проекта.
*   **Обновление:** Обновляются MCP Go Сервером по командам клиента.
*   **Чтение:** Читаются агентами PydanticAI при их запуске или во время работы (если реализована динамическая перезагрузка).

## Взаимодействие

1.  **Клиент -> MCP Go Сервер:** Клиент (например, VSCode с расширением MCP) отправляет команды MCP (например, "запустить агента", "обновить конфигурацию агента") на Go-сервер.
2.  **MCP Go Сервер -> Файлы Конфигурации:** При получении команды на изменение конфигурации, Go-сервер записывает новую конфигурацию в соответствующий JSON-файл.
3.  **MCP Go Сервер -> Агенты PydanticAI:** При получении команды на запуск агента, Go-сервер инициирует новый Python-процесс, передавая ему путь к конфигурационному файлу.
4.  **Агенты PydanticAI -> Файлы Конфигурации:** Запущенный агент PydanticAI читает свою конфигурацию из указанного файла.
5.  **Агенты PydanticAI -> MCP Go Сервер (опционально):** Агенты могут отправлять логи или статус обратно на Go-сервер для мониторинга.

## Принципы проектирования

*   **Модульность:** Каждый компонент и модуль имеет четко определенную ответственность.
*   **Минимализм:** Избегание излишних зависимостей и усложнений.
*   **Надежность:** Обработка ошибок и устойчивость к сбоям.
*   **Расширяемость:** Возможность легко добавлять новые типы агентов или команды MCP.
