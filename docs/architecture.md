# Архитектура системы: MCP-сервер для PydanticAI

## Обзор

Система состоит из двух основных компонентов: легковесного MCP-сервера, написанного на Go, и агентов PydanticAI, написанных на Python. MCP-сервер выступает в качестве центрального узла управления, позволяя удаленно запускать, останавливать и конфигурировать агентов PydanticAI. Конфигурация агентов хранится в текстовых файлах (JSON), которые обновляются MCP-сервером.

## Диаграмма архитектуры

```mermaid
graph TD
    subgraph Клиентская сторона
        A[Пользователь/MCP Клиент]
    end

    subgraph Серверная сторона (Go)
        B(MCP Go Сервер)
        B1[Модуль Обработки Команд MCP]
        B2[Модуль Управления Агентами]
        B3[Модуль Управления Конфигурацией]
        B4[Модуль Мониторинга (опционально)]

        B --> B1
        B --> B2
        B --> B3
        B --> B4
    end

    subgraph Агенты PydanticAI (Python)
        C[Агент PydanticAI 1]
        C2[Агент PydanticAI N]
    end

    subgraph Хранилище
        D[Файлы Конфигурации Агентов (JSON)]
    end

    A -->|Команды MCP (JSON/gRPC)| B
    B1 -->|Вызов функций| B2
    B1 -->|Вызов функций| B3
    B2 -->|Запуск/Остановка процессов| C
    B3 -->|Чтение/Запись| D
    C -->|Чтение конфигурации| D
    C -->|Логи/Статус| B4
```

## Детали компонентов

### 1. MCP Go Сервер

Ядро системы, написанное на Go для обеспечения высокой производительности и низкого потребления ресурсов.

*   **Модуль Обработки Команд MCP:**
    *   Отвечает за прием и парсинг входящих команд MCP от клиента.
    *   Маршрутизирует команды соответствующим внутренним модулям (управления агентами, управления конфигурацией).
    *   Предоставляет инструменты и ресурсы MCP.
*   **Модуль Управления Агентами:**
    *   Отвечает за запуск и остановку процессов агентов PydanticAI.
    *   Использует `os/exec` для взаимодействия с системными процессами.
    *   Может отслеживать состояние запущенных агентов (PID, статус).
    *   Передает агентам пути к их конфигурационным файлам при запуске.
*   **Модуль Управления Конфигурацией:**
    *   Отвечает за чтение, изменение и запись конфигурационных файлов агентов.
    *   Конфигурация хранится в формате JSON.
    *   Обеспечивает атомарность операций записи для предотвращения повреждения файлов.
    *   Может предоставлять API для получения текущей конфигурации агента.
*   **Модуль Мониторинга (опционально):**
    *   Собирает информацию о состоянии запущенных агентов (например, логи, использование ресурсов).
    *   Может предоставлять эту информацию через ресурсы MCP.

### 2. Агенты PydanticAI

Python-приложения, которые выполняют основную логику.

*   **Запуск:** Агенты запускаются MCP Go Сервером.
*   **Конфигурация:** При запуске агент читает свою конфигурацию из указанного JSON-файла. Использует Pydantic для валидации и загрузки конфигурации.
*   **Функциональность:** Выполняет задачи, определенные в его конфигурации.

### 3. Файлы Конфигурации Агентов

Текстовые файлы в формате JSON, содержащие параметры для каждого агента PydanticAI.

*   **Расположение:** Хранятся в предопределенной директории внутри проекта.
*   **Обновление:** Обновляются MCP Go Сервером по командам клиента.
*   **Чтение:** Читаются агентами PydanticAI при их запуске или во время работы (если реализована динамическая перезагрузка).

## Взаимодействие

1.  **Клиент -> MCP Go Сервер:** Клиент (например, VSCode с расширением MCP) отправляет команды MCP (например, "запустить агента", "обновить конфигурацию агента") на Go-сервер.
2.  **MCP Go Сервер -> Файлы Конфигурации:** При получении команды на изменение конфигурации, Go-сервер записывает новую конфигурацию в соответствующий JSON-файл.
3.  **MCP Go Сервер -> Агенты PydanticAI:** При получении команды на запуск агента, Go-сервер инициирует новый Python-процесс, передавая ему путь к конфигурационному файлу.
4.  **Агенты PydanticAI -> Файлы Конфигурации:** Запущенный агент PydanticAI читает свою конфигурацию из указанного файла.
5.  **Агенты PydanticAI -> MCP Go Сервер (опционально):** Агенты могут отправлять логи или статус обратно на Go-сервер для мониторинга.

## Принципы проектирования

*   **Модульность:** Каждый компонент и модуль имеет четко определенную ответственность.
*   **Минимализм:** Избегание излишних зависимостей и усложнений.
*   **Надежность:** Обработка ошибок и устойчивость к сбоям.
*   **Расширяемость:** Возможность легко добавлять новые типы агентов или команды MCP.

## Детализация решений

### 1. Взаимодействие Go-сервера с Python-агентами

*   **Запуск Python-скриптов:** Go-сервер будет использовать стандартную библиотеку `os/exec` для запуска Python-агентов. Команда будет формироваться динамически, включая путь к скрипту агента и путь к его конфигурационному файлу. Пример команды: `python <путь_к_скрипту_агента> --config <путь_к_файлу_конфигурации>`.
*   **Передача аргументов:** Путь к конфигурационному файлу будет передаваться как аргумент командной строки агенту. Агент PydanticAI должен быть реализован таким образом, чтобы парсить этот аргумент (например, с помощью `argparse`) и загружать конфигурацию из указанного файла.
*   **Обработка потоков вывода:** Стандартные потоки вывода (stdout и stderr) Python-процесса будут перенаправляться в логи Go-сервера. Это достигается путем присвоения `Cmd.Stdout` и `Cmd.Stderr` соответствующим `io.Writer` интерфейсам, которые будут записывать данные в систему логирования Go-сервера.

### 2. Управление жизненным циклом агентов

*   **Отслеживание запущенных агентов:** Go-сервер будет поддерживать внутреннюю карту (map) или структуру данных, связывающую `agent_id` с объектом `*os.Process` или его PID. Это позволит отслеживать активные процессы.
*   **Обработка неожиданного завершения:** При запуске агента, Go-сервер будет использовать `Cmd.Wait()` в отдельной goroutine. Когда агент завершится (нормально или с ошибкой), `Wait()` вернет ошибку или nil. Эта goroutine будет фиксировать событие завершения в логах Go-сервера, указывая на `agent_id` и статус завершения. Автоматический перезапуск не предусмотрен на данном этапе.
*   **Остановка агента:** Для остановки агента Go-сервер будет использовать метод `Process.Kill()` или `Process.Signal()` (например, `syscall.SIGTERM` для более "мягкого" завершения, если агент его обрабатывает) на основе сохраненного PID.

### 3. Структура конфигурационных файлов и валидация

*   **Схема конфигурации:** Go-сервер не будет выполнять строгую валидацию схемы JSON перед записью. Он будет просто сериализовать полученный `config_data` (который является `map[string]interface{}` или аналогичной структурой) в JSON-файл. Вся ответственность за валидацию структуры и типов данных лежит на Pydantic на стороне Python-агента. Это упрощает Go-сервер и использует сильные стороны Pydantic.
*   **Именование файлов:** Конфигурационные файлы будут храниться в поддиректории `configs/agents/` внутри корневой директории проекта. Имя файла будет формироваться как `<agent_id>.json`. Например, для `agent_id="my_first_agent"` файл будет `configs/agents/my_first_agent.json`.

### 4. Обработка ошибок и логирование

*   **Логирование:** Go-сервер будет использовать стандартную библиотеку `log` для вывода сообщений. Для более гибкого логирования можно настроить вывод в файл или консоль. Сообщения будут включать метки времени и уровень (INFO, WARN, ERROR).
*   **Сообщение об ошибках:** Все функции инструментов MCP-сервера будут возвращать `error` в случае сбоя. Эти ошибки будут содержать достаточно информации для диагностики (например, "агент с ID X не найден", "не удалось записать файл конфигурации: <причина>"). Эти ошибки будут передаваться обратно MCP-клиенту.

### 5. Масштабируемость и параллелизм

*   **Одновременные запросы:** Каждый входящий MCP-запрос будет обрабатываться в отдельной `goroutine`. Это позволяет серверу одновременно обслуживать несколько клиентов и выполнять несколько операций (запуск, остановка, обновление) без блокировки.
*   **Управление агентами:** Для каждого запущенного агента PydanticAI будет создана отдельная `goroutine`, которая будет отвечать за запуск процесса, перенаправление его вывода и ожидание его завершения. Это обеспечивает изоляцию и параллельное управление множеством агентов.

### 6. Безопасность

*   **Несанкционированный доступ:** На данном этапе, для обеспечения максимальной простоты и минимализма, не будет реализована сложная аутентификация или авторизация для MCP-запросов. Предполагается, что MCP-сервер будет развернут в контролируемой и доверенной среде (например, в локальной сети или с использованием VPN/фаервола).
*   **Конфиденциальные данные:** Рекомендуется, чтобы конфиденциальные данные (например, API-ключи, учетные данные) не передавались напрямую в `config_data` через MCP-запросы и не хранились в открытом виде в JSON-файлах. Вместо этого агенты PydanticAI должны быть спроектированы для получения таких данных из переменных окружения или других безопасных хранилищ, доступных только им.

### 7. Мониторинг (детализация)

*   **Метрики:** MCP-сервер будет предоставлять базовый статус агента: `running` (запущен) или `stopped` (остановлен), а также его PID, если он запущен. Эта информация будет доступна через инструмент `get_agent_status`.
*   **Логирование:** Перенаправление stdout/stderr агентов в логи Go-сервера является основным механизмом для получения информации о работе агентов. Это позволяет просматривать их вывод и ошибки в централизованном месте.
</content>
